import os
import shutil
import json
import argparse
from collections import defaultdict

CONFIG_FILE = 'config.json'

def load_config():
    """Loads configuration settings from config.json."""
    try:
        with open(CONFIG_FILE, 'r') as f:
            config = json.load(f)
            
            # Reformat categories for quick lookup: {extension: folder}
            category_map = {}
            for folder, extensions in config.get('categories', {}).items():
                for ext in extensions:
                    category_map[ext.lower()] = folder
                    
            config['category_map'] = category_map
            return config
            
    except FileNotFoundError:
        print(f"‚ùå Error: Configuration file '{CONFIG_FILE}' not found.")
        return None
    except json.JSONDecodeError:
        print(f"‚ùå Error: Could not parse '{CONFIG_FILE}'. Check JSON formatting.")
        return None

def organize_files(directory_path, category_map, default_folder):
    """
    Scans the directory and moves files into categorized folders.
    """
    print(f"üöÄ Starting file organization in: {directory_path}")
    
    if not os.path.isdir(directory_path):
        print(f"‚ùå Error: Directory not found at {directory_path}")
        return

    files_moved = 0
    
    # Iterate through all files in the target directory
    for item in os.listdir(directory_path):
        source_path = os.path.join(directory_path, item)
        
        # Skip directories, the script itself, and the config file
        if os.path.isdir(source_path) or item in ['file_organizer.py', CONFIG_FILE]:
            continue
        
        file_name, file_extension = os.path.splitext(item)
        file_extension = file_extension.lower() # Normalize case

        # Determine the category folder using the map, default to 'Other'
        category_folder = category_map.get(file_extension, default_folder)

        # Define the full destination path
        destination_folder = os.path.join(directory_path, category_folder)
        destination_path = os.path.join(destination_folder, item)

        try:
            # Create the destination folder if it doesn't exist
            os.makedirs(destination_folder, exist_ok=True)
            
            # Move the file
            shutil.move(source_path, destination_path)
            
            print(f"‚úÖ Moved: '{item}' -> '{category_folder}'")
            files_moved += 1

        except Exception as e:
            print(f"‚ö†Ô∏è Could not move file {item}. Error: {e}")

    print(f"\nüéâ Organization complete! Total files moved: {files_moved}")

if __name__ == "__main__":
    
    # Setup CLI Argument Parser
    parser = argparse.ArgumentParser(
        description="Automated File Organizer Script.",
        formatter_class=argparse.RawTextHelpFormatter
    )
    # The --dir argument lets the user specify the path when running the script
    parser.add_argument(
        '--dir',
        type=str,
        help="Specify the directory path to organize. Overrides 'target_directory' in config.json."
    )
    args = parser.parse_args()
    
    # Load settings from config.json
    config_data = load_config()
    
    if config_data:
        # Determine the final directory: CLI argument takes precedence
        target_dir = args.dir if args.dir else config_data.get('target_directory')
        
        if not target_dir:
            print("‚ùå Error: No target directory specified. Set it in config.json or use the --dir argument.")
        else:
            organize_files(target_dir, config_data['category_map'], config_data.get('default_folder', 'Other'))
